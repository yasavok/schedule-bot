# Архитектура проекта

## Обзор

Telegram-бот построен на модульной архитектуре с разделением ответственности между компонентами.

## Структура модулей

```
┌─────────────────────────────────────────────────────────────┐
│                         bot.py                              │
│                    (Точка входа)                            │
└────────────┬────────────────────────────────────────────────┘
             │
             ├──────────────┬──────────────┬──────────────┐
             │              │              │              │
             ▼              ▼              ▼              ▼
      ┌──────────┐   ┌──────────┐  ┌──────────┐  ┌──────────┐
      │ handlers │   │scheduler │  │  parser  │  │ database │
      │   .py    │   │   .py    │  │   .py    │  │   .py    │
      └────┬─────┘   └────┬─────┘  └────┬─────┘  └────┬─────┘
           │              │             │             │
           │              │             │             │
           ▼              ▼             ▼             ▼
      ┌──────────┐   ┌──────────┐  ┌──────────┐  ┌──────────┐
      │keyboards │   │  Aiogram │  │ aiohttp  │  │  SQLite  │
      │   .py    │   │   Bot    │  │BeautifulS│  │   DB     │
      └──────────┘   └──────────┘  └──────────┘  └──────────┘
```

## Описание модулей

### bot.py
**Назначение:** Главный файл запуска приложения

**Функции:**
- Инициализация бота и диспетчера
- Регистрация обработчиков
- Запуск фонового планировщика
- Обработка ошибок верхнего уровня

**Зависимости:** handlers, scheduler, config

---

### config.py
**Назначение:** Централизованная конфигурация

**Содержит:**
- Токен бота
- URL сайта колледжа
- Интервал проверки обновлений
- Пути к файлам и папкам

**Зависимости:** python-dotenv

---

### database.py
**Назначение:** Работа с базой данных пользователей

**Класс:** `Database`

**Методы:**
- `init_db()` - создание таблиц
- `add_user()` - добавление пользователя
- `remove_user()` - удаление пользователя
- `is_subscribed()` - проверка подписки
- `get_all_users()` - получение всех пользователей
- `get_users_count()` - подсчет пользователей

**Зависимости:** sqlite3

**Схема БД:**
```sql
CREATE TABLE users (
    user_id INTEGER PRIMARY KEY,
    username TEXT,
    first_name TEXT,
    subscribed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
)
```

---

### parser.py
**Назначение:** Парсинг расписания с сайта колледжа

**Класс:** `ScheduleParser`

**Методы:**
- `fetch_page()` - загрузка HTML страницы
- `download_image()` - скачивание изображения
- `parse_schedule_images()` - парсинг изображений из HTML
- `calculate_hash()` - вычисление MD5 хэша
- `get_last_hash()` - получение сохраненного хэша
- `save_hash()` - сохранение хэша
- `check_for_updates()` - проверка наличия обновлений

**Зависимости:** aiohttp, BeautifulSoup4

**Алгоритм работы:**
```
1. Загрузить HTML страницу
2. Найти изображения расписания
3. Скачать первое изображение
4. Вычислить MD5 хэш
5. Сравнить с предыдущим хэшем
6. Если отличается → новое расписание
7. Сохранить файл и хэш
```

---

### scheduler.py
**Назначение:** Фоновая проверка обновлений и рассылка

**Функции:**
- `check_schedule_updates()` - проверка обновлений
- `send_schedule_to_users()` - рассылка расписания
- `start_schedule_checker()` - запуск планировщика

**Зависимости:** parser, database, aiogram

**Поток выполнения:**
```
┌─────────────────────────────────────┐
│  Запуск планировщика                │
└──────────────┬──────────────────────┘
               │
               ▼
┌─────────────────────────────────────┐
│  Проверка обновлений (parser)       │
└──────────────┬──────────────────────┘
               │
               ▼
        ┌──────┴──────┐
        │ Есть новое? │
        └──────┬──────┘
               │
        ┌──────┴──────┐
        │ Да          │ Нет
        ▼             ▼
┌──────────────┐  ┌──────────────┐
│ Рассылка     │  │ Ждать        │
│ пользователям│  │ интервал     │
└──────────────┘  └──────────────┘
        │             │
        └──────┬──────┘
               ▼
┌─────────────────────────────────────┐
│  Ждать CHECK_INTERVAL секунд        │
└──────────────┬──────────────────────┘
               │
               └──────────────────────┐
                                      │
                                      ▼
                              (повтор цикла)
```

---

### handlers.py
**Назначение:** Обработка команд и сообщений от пользователей

**Обработчики команд:**
- `cmd_start()` - /start
- `cmd_subscribe()` - /subscribe
- `cmd_unsubscribe()` - /unsubscribe
- `cmd_info()` - /info
- `cmd_stats()` - /stats

**Обработчики кнопок:**
- `handle_subscribe_button()` - кнопка "Подписаться"
- `handle_unsubscribe_button()` - кнопка "Отписаться"
- `handle_info_button()` - кнопка "Информация"
- `handle_stats_button()` - кнопка "Статистика"

**Обработчики callback:**
- `callback_subscribe()` - inline кнопка подписки
- `callback_unsubscribe()` - inline кнопка отписки

**Зависимости:** database, keyboards, aiogram

---

### keyboards.py
**Назначение:** Создание клавиатур для бота

**Функции:**
- `get_main_keyboard()` - главная Reply-клавиатура
- `get_inline_subscribe_keyboard()` - Inline-клавиатура подписки

**Зависимости:** aiogram.types

---

## Поток данных

### Подписка пользователя
```
Пользователь → /start → handlers.py → database.py → SQLite
                  ↓
            keyboards.py → Reply клавиатура → Пользователь
```

### Проверка и рассылка расписания
```
scheduler.py → parser.py → Сайт колледжа
     ↓              ↓
     ↓         Скачать изображение
     ↓              ↓
     ↓         Вычислить хэш
     ↓              ↓
     ↓         Сравнить с предыдущим
     ↓              ↓
     └──────────────┤
                    ↓
            Новое расписание?
                    ↓
            database.py → Получить пользователей
                    ↓
            Отправить фото каждому
                    ↓
            Обработать ошибки (блокировки)
```

## Обработка ошибок

### Уровни обработки

1. **Модульный уровень** - каждый модуль обрабатывает свои ошибки
2. **Логирование** - все ошибки записываются в `bot.log`
3. **Восстановление** - бот продолжает работу после ошибок

### Типы ошибок

| Ошибка | Обработка |
|--------|-----------|
| Сайт недоступен | Логирование, повтор через интервал |
| Пользователь заблокировал бота | Удаление из БД |
| Ошибка отправки | Логирование, продолжение рассылки |
| Ошибка БД | Логирование, возврат False |
| Ошибка парсинга | Логирование, возврат пустого списка |

## Безопасность

### Защита данных
- Токен бота в `.env` (не в git)
- База данных с ограниченным доступом
- Валидация входных данных

### Ограничения
- Задержка между отправками (0.05 сек)
- Обработка блокировок от пользователей
- Таймауты для HTTP запросов (30 сек)

## Масштабируемость

### Текущие ограничения
- Один процесс бота
- SQLite (подходит до ~10000 пользователей)
- Синхронная рассылка

### Возможные улучшения
- PostgreSQL для больших нагрузок
- Очередь задач (Celery, RQ)
- Кластеризация ботов
- Кэширование расписаний

## Зависимости

```
aiogram 3.x
├── aiohttp (HTTP клиент)
└── asyncio (асинхронность)

beautifulsoup4
└── lxml (парсер HTML)

python-dotenv (переменные окружения)

sqlite3 (встроен в Python)
```

## Файловая система

```
project/
├── bot.py                    # Главный файл
├── config.py                 # Конфигурация
├── database.py               # БД модуль
├── parser.py                 # Парсер
├── scheduler.py              # Планировщик
├── handlers.py               # Обработчики
├── keyboards.py              # Клавиатуры
├── .env                      # Токен (не в git)
├── database.db               # SQLite БД
├── bot.log                   # Логи
├── last_schedule_hash.txt    # Хэш последнего расписания
└── schedules/                # Папка с расписаниями
    ├── schedule_20240227_120000.jpg
    └── ...
```

## Жизненный цикл

```
1. Запуск bot.py
2. Загрузка конфигурации (config.py)
3. Инициализация БД (database.py)
4. Регистрация обработчиков (handlers.py)
5. Запуск планировщика (scheduler.py)
6. Запуск polling (aiogram)
7. ┌─ Обработка команд пользователей
   └─ Фоновая проверка расписания
8. Остановка (Ctrl+C)
9. Закрытие соединений
```

## Тестирование

### Ручное тестирование
- `test_parser.py` - тест парсера
- `manual_send.py` - ручная рассылка

### Автоматическое тестирование
Можно добавить:
- Unit тесты (pytest)
- Интеграционные тесты
- Моки для HTTP запросов

## Мониторинг

### Логирование
- Уровень: INFO
- Вывод: консоль + файл
- Формат: timestamp - module - level - message

### Метрики
- Количество пользователей
- Успешность рассылок
- Ошибки парсинга
- Время проверки обновлений
